# 树莓派运行指令（精简版）

## 1) 首次部署

在树莓派执行：

```bash
sudo mkdir -p /opt/pm-shadow
sudo chown -R $USER:$USER /opt/pm-shadow
```

在 Windows 项目根目录执行：

```powershell
scp -r . pi@<pi-ip>:/opt/pm-shadow
```

在树莓派执行：

```bash
cd /opt/pm-shadow
python3 -m venv .venv
./.venv/bin/python -m pip install -r requirements.txt
```

## 2) 运行命令（核心）

```bash
cd /opt/pm-shadow
```

- 影子模式（不下单）：

```bash
./.venv/bin/python run_shadow.py --days 7 --state-db shadow_state.db --out-dir reports
```

- 实盘模式（小额）：

```bash
./.venv/bin/python run_shadow.py --days 7 --state-db shadow_state.db --out-dir reports --live
```

- Dual 模式（shadow + live 同跑）：

```bash
./.venv/bin/python run_shadow.py --days 7 --state-db shadow_state.db --out-dir reports --dual
```

- Dual 且每次按当前余额重开（推荐）：

```bash
./.venv/bin/python run_shadow.py --days 7 --state-db shadow_state.db --out-dir reports --dual --reset-state --sync-live-cash
```

- 下单连通性自检（先 dry-run，再小额实测）：

```bash
# 只做检查，不下单
./.venv/bin/python check_order_connectivity.py

# 小额下单并自动撤单（用于判断 API 通路是否正常）
./.venv/bin/python check_order_connectivity.py --live --usdc 2 --cancel-after-sec 5
```

## 3) 新增参数说明

- `--reset-state`：启动前删除 `state-db` 与 `live-state-db`，从头开始。
- `--sync-live-cash`：启动时强制同步实时现金（优先 CLOB；dual 下 shadow/live 同步为同一初始值）。
- 两者常用于解决“报告初始资金与账户实际余额不一致”。

## 4) 报告与账本

- Dual 会生成：
  - `reports/shadow_kpi.md` / `.json`
  - `reports/live_kpi.md` / `.json`
  - `reports/dual_<用户>_<时间戳>.jsonl`
- 账本默认：
  - shadow：`shadow_state.db`
  - live：`shadow_state_live.db`（可用 `--live-state-db` 自定义）

## 5) systemd（可选）

```bash
sudo cp /opt/pm-shadow/deploy/pm_shadow.service /etc/systemd/system/pm_shadow.service
sudo systemctl daemon-reload
sudo systemctl enable --now pm_shadow.service
sudo systemctl status pm_shadow.service
journalctl -u pm_shadow.service -f
```

> 跑实盘前必须配置 `.env`（`PRIVATE_KEY`、`FUNDER_ADDRESS`、`POLY_API_KEY`、`POLY_SECRET`、`POLY_PASSPHRASE`）。
