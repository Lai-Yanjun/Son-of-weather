# 树莓派运行指令

下面所有命令按顺序在对应环境执行即可。将 `<pi-ip>` 换成你的树莓派 IP，将 `pi` 换成你的 SSH 用户名（若不同）。

---

## 一、在 Windows 上：把项目传到树莓派

在**项目根目录**（天气之子）下打开 PowerShell，执行：

```powershell
# 先创建目录并赋权（在树莓派上执行，见下一节）
# 传项目（把 天气之子 整份传到树莓派 /opt/pm-shadow）
scp -r . pi@<pi-ip>:/opt/pm-shadow
```

若树莓派上还没有 `/opt/pm-shadow`，需要先在树莓派上创建（见下一节「二、在树莓派上：准备目录」）。

---

## 二、在树莓派上：准备目录（首次部署时执行一次）

SSH 登录树莓派后：

```bash
sudo mkdir -p /opt/pm-shadow
sudo chown -R $USER:$USER /opt/pm-shadow
```

若你是从 Windows 用 scp 传整个目录，也可以先在本机建好目录再传：

```bash
# 树莓派上
sudo mkdir -p /opt/pm-shadow
sudo chown -R $USER:$USER /opt/pm-shadow
```

然后再在 Windows 执行：`scp -r . pi@<pi-ip>:/opt/pm-shadow`

---

## 三、在树莓派上：安装依赖并跑影子跟单

```bash
cd /opt/pm-shadow

# 创建虚拟环境
python3 -m venv .venv

# 安装依赖
./.venv/bin/python -m pip install -r requirements.txt

# 跑 7 天影子（不下单，只写 reports 和 shadow_state.db）
./.venv/bin/python run_shadow.py --days 7 --state-db shadow_state.db --out-dir reports
```

前台运行会一直占用终端。要后台常驻请用下一节的 systemd。

---

## 四、在树莓派上：用 systemd 后台常驻（可选）

```bash
# 安装 service 文件
sudo cp /opt/pm-shadow/deploy/pm_shadow.service /etc/systemd/system/pm_shadow.service

# 重载并启用、启动
sudo systemctl daemon-reload
sudo systemctl enable --now pm_shadow.service

# 查看状态
sudo systemctl status pm_shadow.service

# 实时看日志
journalctl -u pm_shadow.service -f

# 停止
sudo systemctl stop pm_shadow.service

# 禁用开机自启
sudo systemctl disable pm_shadow.service
```

---

## 五、常用命令速查

| 操作           | 命令 |
|----------------|------|
| 前台跑 7 天    | `./.venv/bin/python run_shadow.py --days 7 --state-db shadow_state.db --out-dir reports` |
| 看 KPI         | `cat /opt/pm-shadow/reports/shadow_kpi.md` |
| 看 service 状态 | `sudo systemctl status pm_shadow.service` |
| 看日志         | `journalctl -u pm_shadow.service -f` |
| 停止 service   | `sudo systemctl stop pm_shadow.service` |
| 从头回放（清状态） | `rm /opt/pm-shadow/shadow_state.db` 后再跑 |

---

**说明**：只跑影子（不加 `--live`）不需要在树莓派上配置 `.env` 或私钥。
