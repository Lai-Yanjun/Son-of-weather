# 树莓派网络测试指令（API 地域限制排查）

用途：定位“网页可下单，但脚本/API 报 `GEO_BLOCK_403`”的问题。  
原则：同一订阅不代表同一路由，必须验证 **系统进程** 实际出口。

## 0) 前提

```bash
cd /opt/pm-shadow
```

确保已安装依赖且有 `.env`。

## 0.1 一键设置代理环境（可直接粘贴）

> Clash 常见本地端口是 `7890`，如不一致请自行修改。

```bash
export http_proxy=http://127.0.0.1:7890
export https_proxy=http://127.0.0.1:7890
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890
export no_proxy=localhost,127.0.0.1
export NO_PROXY=localhost,127.0.0.1
```

## 1) 先排除最小下单量干扰

> 连通性测试时，`--usdc` 建议 `>= 6`，避免命中“最小下单量”导致误判。

```bash
./.venv/bin/python check_order_connectivity.py --live --usdc 6 --cancel-after-sec 5
```

结果判读：
- `RESULT: success (api path works)`：API 通路正常
- `RESULT: failed (GEO_BLOCK_403)`：大概率是出口/地区风控
- `POLY_API_400 ... lower than the minimum`：只是下单量太小，不是地区问题

## 2) 检查系统进程出口（不是浏览器）

```bash
# IPv4 出口
curl -4 https://ifconfig.me

# IPv6 出口（若有）
curl -6 https://ifconfig.me
```

若 IPv6 显示为本地运营商地址，可能存在 IPv6 泄漏。

## 3) 检查 Python 进程出口

```bash
python3 -c "import urllib.request; print(urllib.request.urlopen('https://ifconfig.me/ip', timeout=10).read().decode().strip())"
```

要求：Python 输出应与代理后的预期出口一致。

## 4) 直接探测 Polymarket API 可达性

```bash
curl -I https://clob.polymarket.com
curl -I https://data-api.polymarket.com
```

若这里就异常（超时/拒绝/异常 4xx），优先处理网络路由问题。

## 5) 前台 vs 后台（systemd）对照

先前台手动跑（当前 shell）：

```bash
cd /opt/pm-shadow
./.venv/bin/python check_order_connectivity.py --live --usdc 6 --cancel-after-sec 5
```

再看后台服务日志：

```bash
sudo systemctl status pm_shadow.service
journalctl -u pm_shadow.service -f
```

若前台成功但后台 `GEO_BLOCK_403`，说明 systemd 进程没有走同一代理路径。

## 6) 建议的快速修复路径

1. Clash 开启 TUN，并临时切到全局模式做验证。  
2. 临时禁用 IPv6（或确保 IPv6 也走代理）。  
3. 确认脚本运行环境与浏览器一致（不要只看浏览器可用）。  
4. 再次执行第 1 步连通性测试确认结果。  

## 7) 一键复测（建议）

```bash
cd /opt/pm-shadow
curl -4 https://ifconfig.me
curl -6 https://ifconfig.me || true
./.venv/bin/python check_order_connectivity.py --live --usdc 6 --cancel-after-sec 5 --proxy http://127.0.0.1:7890
```

将以上三段输出保存，即可快速判断是否是网络地区问题。

## 8) 运行主策略时强制走代理（可直接粘贴）

```bash
cd /opt/pm-shadow
./.venv/bin/python run_shadow.py --dual --sync-live-cash --reset-state --days 7 --state-db shadow_state.db --out-dir reports --proxy http://127.0.0.1:7890
```
