# 树莓派网络修复指令（可直接粘贴）

## 1) 先查 Clash 实际监听端口（修正版）

```bash
# 正确查常见端口监听
ss -lntp | grep -E '(:7890|:7891|:9090|:2019|:2020)\b' || true

# 按 mihomo 进程号查（你的示例进程号是 46754；如果变化请替换）
ss -lntp | grep 46754 || true

# 从 Clash 配置读取端口键
python3 - <<'PY'
from pathlib import Path
p = Path("/home/lai/.local/share/io.github.clash-verge-rev.clash-verge-rev/clash-verge.yaml")
print("config exists:", p.exists(), p)
if p.exists():
    txt = p.read_text(encoding="utf-8", errors="ignore").splitlines()
    keys = ("mixed-port:", "port:", "socks-port:", "redir-port:", "tproxy-port:", "allow-lan:", "mode:", "external-controller:")
    for i, line in enumerate(txt, 1):
        s = line.strip()
        if any(s.startswith(k) for k in keys):
            print(f"{i}: {line}")
PY
```

## 2) 如果找到了 HTTP/mixed 端口，按端口重测

> 你当前已确认端口是 `7897`，可直接用下面命令；若后续变更再替换。

```bash
cd /opt/pm-shadow/Son-of-weather
unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY all_proxy ALL_PROXY
export http_proxy=http://127.0.0.1:7897
export https_proxy=http://127.0.0.1:7897
export HTTP_PROXY=http://127.0.0.1:7897
export HTTPS_PROXY=http://127.0.0.1:7897
export no_proxy=localhost,127.0.0.1
export NO_PROXY=localhost,127.0.0.1
curl -4 https://ifconfig.me
curl -6 https://ifconfig.me || true
./.venv/bin/python check_order_connectivity.py --live --usdc 6 --cancel-after-sec 5 --proxy http://127.0.0.1:7897
```

## 3) 结果处理

- `RESULT: success (api path works)`  
  说明链路已通，可启动主策略：
  ```bash
  cd /opt/pm-shadow/Son-of-weather
  ./.venv/bin/python run_shadow.py --dual --sync-live-cash --reset-state --days 7 --state-db shadow_state.db --out-dir reports --proxy http://127.0.0.1:7897
  ```

- `RESULT: failed (GEO_BLOCK_403)`  
  说明仍被地区风控，优先检查：
  1) Clash 是否 TUN + 全局  
  2) IPv6 是否泄漏（必要时先禁用 IPv6 再测）

- `POLY_API_400 ... lower than the minimum`  
  不是地区问题，是下单量太小；保持 `--usdc >= 6` 重测即可。

## 4) 后续稳定运行指引

1) 每次重启后先跑一次连通性测试，再开主策略。  
2) 若再次出现 403，先检查 `mixed-port` 是否变化，再同步替换命令里的端口。  
3) systemd 场景建议在 service 里固定 `http_proxy/https_proxy`，避免前台成功后台失败。
